<!DOCTYPE html>
<html lang="ja">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>ç–²å‹æ“¬æ…‹èªï¼šãƒ˜ãƒˆãƒ˜ãƒˆ vs ã‚¯ã‚¿ã‚¯ã‚¿ (ä¸­æ—¥å°ç…§ç‰ˆ)</title>
    
    <!-- Fonts: Zen Maru Gothic (Cute/Rounded) & Kiwi Maru (Artistic) -->
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Kiwi+Maru:wght@400;500&family=Zen+Maru+Gothic:wght@400;700&display=swap" rel="stylesheet">
    
    <!-- Icons -->
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">

    <style>
        :root {
            /* --- Fatigue & Exhaustion Palette --- */
            
            /* Background Gradient - Tired afternoon/evening feel */
            --bg-gradient: linear-gradient(135deg, #e0e0e0 0%, #cfd8dc 100%);
            
            /* Theme Colors for Specific Slides */
            --theme-brown: #8d6e63;   /* Heto-heto (Mud/Earth) */
            --theme-green: #7cb342;   /* Kuta-kuta (Wilted Leaf) */
            --theme-purple: #7e57c2;  /* Guttari (Sickly/Drained) */
            --theme-blue: #3949ab;    /* Batan-kyu (Night/Sleep) */
            --theme-grey: #78909c;    /* Boro-boro (Worn out/Grey) */
            --theme-intro: #546e7a;   /* Intro/Outro */

            /* UI Colors */
            --card-bg: rgba(255, 255, 255, 0.95);
            --text-color: #37474f;
            --text-sub: #607d8b;
            
            /* Fonts */
            --font-title: 'Kiwi Maru', serif;
            --font-body: 'Zen Maru Gothic', sans-serif;
        }

        * {
            box-sizing: border-box;
            user-select: none;
        }

        body {
            margin: 0;
            padding: 0;
            background: #eceff1; 
            background-image: 
                radial-gradient(circle at 10% 20%, rgba(141, 110, 99, 0.1) 0%, transparent 20%),
                radial-gradient(circle at 90% 80%, rgba(57, 73, 171, 0.1) 0%, transparent 20%);
            font-family: var(--font-body);
            color: var(--text-color);
            height: 100vh;
            overflow: hidden;
            display: flex;
            flex-direction: column;
        }

        /* --- Toolbar --- */
        .toolbar {
            position: fixed;
            top: 20px;
            left: 20px;
            background: rgba(255, 255, 255, 0.95);
            padding: 12px;
            border-radius: 25px;
            box-shadow: 0 10px 25px rgba(0,0,0,0.1);
            display: flex;
            flex-direction: column;
            gap: 15px;
            z-index: 1000;
            backdrop-filter: blur(10px);
            border: 2px solid #fff;
        }

        .tool-btn {
            width: 50px;
            height: 50px;
            border: none;
            border-radius: 20px;
            background: #fff;
            color: #555;
            cursor: pointer;
            transition: transform 0.2s cubic-bezier(0.34, 1.56, 0.64, 1);
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 1.4rem;
            box-shadow: 0 4px 10px rgba(0,0,0,0.05);
        }

        #btn-brush:hover, #btn-brush.active { background: #d7ccc8; color: #5d4037; }
        #btn-eraser:hover, #btn-eraser.active { background: #eceff1; color: #455a64; }
        #btn-text:hover, #btn-text.active { background: #dcedc8; color: #33691e; }
        #btn-move:hover, #btn-move.active { background: #c5cae9; color: #283593; }
        #btn-print:hover, #btn-print.active { background: #cfd8dc; color: #37474f; }

        .tool-btn:hover { transform: scale(1.1) rotate(5deg); }
        .tool-btn:active { transform: scale(0.95); }

        .color-palette {
            display: grid;
            grid-template-columns: repeat(2, 1fr);
            gap: 8px;
            margin-top: 5px;
            padding-top: 10px;
            border-top: 2px dashed #eee;
        }

        .color-swatch {
            width: 24px;
            height: 24px;
            border-radius: 50%;
            cursor: pointer;
            border: 3px solid white;
            box-shadow: 0 2px 5px rgba(0,0,0,0.15);
            transition: transform 0.2s;
        }
        .color-swatch:hover { transform: scale(1.2); }
        .color-swatch.active { transform: scale(1.2); border-color: #333; }

        /* --- Slide Container --- */
        #app-container {
            flex: 1;
            display: flex;
            justify-content: center;
            align-items: center;
            padding: 20px 100px;
            position: relative;
        }

        .slide {
            width: 100%;
            max-width: 1100px;
            height: 100%;
            max-height: 90vh;
            aspect-ratio: 16/9;
            background: var(--card-bg);
            border-radius: 35px;
            box-shadow: 0 20px 50px rgba(0,0,0,0.1);
            position: relative;
            display: none;
            overflow: hidden;
            flex-direction: column;
            border: 6px solid #fff;
        }

        .slide.active { display: flex; }

        /* Dynamic Theme Styles */
        /* Brown - Heto-heto */
        .slide[data-theme="brown"] { border-color: #d7ccc8; }
        .slide[data-theme="brown"] .slide-title { color: var(--theme-brown); }
        .slide[data-theme="brown"] .situation-tag { background: var(--theme-brown); }
        .slide[data-theme="brown"] .col-right { background: linear-gradient(135deg, #efebe9, #fff); }

        /* Green - Kuta-kuta */
        .slide[data-theme="green"] { border-color: #dcedc8; }
        .slide[data-theme="green"] .slide-title { color: var(--theme-green); }
        .slide[data-theme="green"] .situation-tag { background: var(--theme-green); }
        .slide[data-theme="green"] .col-right { background: linear-gradient(135deg, #f1f8e9, #fff); }

        /* Purple - Guttari */
        .slide[data-theme="purple"] { border-color: #d1c4e9; }
        .slide[data-theme="purple"] .slide-title { color: var(--theme-purple); }
        .slide[data-theme="purple"] .situation-tag { background: var(--theme-purple); }
        .slide[data-theme="purple"] .col-right { background: linear-gradient(135deg, #ede7f6, #fff); }

        /* Blue - Batan-kyu */
        .slide[data-theme="blue"] { border-color: #c5cae9; }
        .slide[data-theme="blue"] .slide-title { color: var(--theme-blue); }
        .slide[data-theme="blue"] .situation-tag { background: var(--theme-blue); }
        .slide[data-theme="blue"] .col-right { background: linear-gradient(135deg, #e8eaf6, #fff); }

        /* Grey - Boro-boro */
        .slide[data-theme="grey"] { border-color: #cfd8dc; }
        .slide[data-theme="grey"] .slide-title { color: var(--theme-grey); }
        .slide[data-theme="grey"] .situation-tag { background: var(--theme-grey); }
        .slide[data-theme="grey"] .col-right { background: linear-gradient(135deg, #eceff1, #fff); }

        /* Intro */
        .slide[data-theme="intro"] { border-color: #b0bec5; }
        .slide[data-theme="intro"] .slide-title { color: var(--theme-intro); }
        .slide[data-theme="intro"] .situation-tag { background: var(--theme-intro); }
        .slide[data-theme="intro"] .col-right { background: linear-gradient(135deg, #cfd8dc, #fff); }


        /* Layers */
        .drawing-layer, .text-layer {
            position: absolute; top: 0; left: 0; width: 100%; height: 100%;
        }
        .drawing-layer { z-index: 10; cursor: crosshair; touch-action: none; }
        .text-layer { z-index: 11; pointer-events: none; }

        .user-text {
            position: absolute;
            background: rgba(255,255,255,0.9);
            border: 2px dashed #607d8b;
            padding: 5px 10px;
            border-radius: 10px;
            font-family: var(--font-body);
            font-weight: bold;
            font-size: 1.2rem;
            color: #37474f;
            pointer-events: auto;
            cursor: text;
        }
        .user-text.draggable { cursor: grab; background: #eceff1; border-style: solid; }

        /* Content Layout */
        .slide-content {
            padding: 35px 50px;
            height: 100%;
            display: flex;
            flex-direction: column;
            z-index: 1;
        }

        .slide-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 20px;
            padding-bottom: 10px;
            border-bottom: 3px dotted #cfd8dc;
        }

        .slide-title {
            font-family: var(--font-title);
            font-size: 2.2rem;
            margin: 0;
            text-shadow: 1px 1px 0 rgba(0,0,0,0.05);
        }

        .slide-number {
            font-family: var(--font-body);
            font-weight: 700;
            color: #fff;
            font-size: 1.1rem;
            background: #90a4ae;
            padding: 5px 15px;
            border-radius: 20px;
        }

        .slide-body {
            flex: 1;
            display: flex;
            gap: 40px;
            overflow: hidden;
        }

        .col-left {
            flex: 1.1;
            display: flex;
            flex-direction: column;
            overflow-y: auto;
            padding-right: 10px;
        }

        .col-right {
            flex: 0.9;
            display: flex;
            justify-content: center;
            align-items: center;
            border-radius: 30px;
            position: relative;
            border: 5px solid #fff;
            box-shadow: inset 0 0 20px rgba(0,0,0,0.03);
        }

        /* Scrollbar */
        .col-left::-webkit-scrollbar { width: 8px; }
        .col-left::-webkit-scrollbar-track { background: transparent; }
        .col-left::-webkit-scrollbar-thumb { background-color: #b0bec5; border-radius: 4px; }

        /* Elements */
        .big-word {
            font-family: var(--font-title);
            font-size: 3.5rem;
            color: #455a64;
            font-weight: bold;
            margin-bottom: 5px;
            line-height: 1.2;
        }

        .situation-tag {
            display: inline-block;
            color: white;
            padding: 6px 18px;
            border-radius: 20px;
            font-size: 1rem;
            margin-bottom: 20px;
            box-shadow: 0 4px 10px rgba(0,0,0,0.1);
        }

        .definition-box {
            background: #fff;
            padding: 15px 20px;
            border-radius: 15px;
            border-left: 6px solid #ccc;
            box-shadow: 0 5px 15px rgba(0,0,0,0.03);
            margin-bottom: 20px;
        }

        .def-jp { font-size: 1.2rem; margin-bottom: 5px; color: #37474f; }
        .def-tw { font-size: 1rem; color: #78909c; font-weight: normal; opacity: 0.8; }

        /* Chat Box */
        .chat-container {
            background: #fafafa;
            border-radius: 20px;
            padding: 15px;
            display: flex;
            flex-direction: column;
            gap: 12px;
            margin-top: auto;
            border: 2px solid #eee;
        }

        .chat-title {
            font-size: 0.9rem;
            color: #90a4ae;
            text-align: center;
            margin-bottom: 5px;
            letter-spacing: 1px;
        }

        .chat-row { display: flex; align-items: flex-start; gap: 10px; }
        .chat-row.right { flex-direction: row-reverse; }

        .chat-avatar {
            width: 40px; height: 40px;
            border-radius: 50%;
            background: #fff;
            display: flex; align-items: center; justify-content: center;
            font-size: 1.2rem;
            border: 2px solid #cfd8dc;
            color: #546e7a;
        }

        .chat-bubble {
            max-width: 85%;
            padding: 10px 15px;
            border-radius: 18px;
            font-size: 1.05rem;
            line-height: 1.4;
            position: relative;
            box-shadow: 0 2px 5px rgba(0,0,0,0.05);
        }

        .chat-row.left .chat-bubble { background: #fff; color: #455a64; border-top-left-radius: 4px; }
        .chat-row.right .chat-bubble { background: #78909c; color: #fff; border-top-right-radius: 4px; }

        /* Illustration */
        .illustration {
            font-size: 8rem;
            filter: drop-shadow(0 15px 0px rgba(0,0,0,0.1));
            animation: breathe 4s infinite;
        }
        @keyframes breathe {
            0%, 100% { transform: scale(1); opacity: 1; }
            50% { transform: scale(0.95); opacity: 0.8; }
        }

        /* Nav Buttons */
        .nav-btn {
            position: fixed; top: 50%; transform: translateY(-50%);
            background: rgba(255,255,255,0.8);
            color: #607d8b;
            width: 60px; height: 60px;
            border-radius: 50%; border: none;
            box-shadow: 0 5px 15px rgba(0,0,0,0.1);
            font-size: 1.5rem; cursor: pointer; z-index: 1100;
            transition: all 0.2s;
            backdrop-filter: blur(5px);
        }
        .nav-btn:hover { transform: translateY(-50%) scale(1.1); background: #fff; color: #37474f; }
        
        #prev-btn { left: 100px; } 
        #next-btn { right: 100px; }

        @media print {
            .toolbar, .nav-btn { display: none !important; }
            #app-container { padding: 0; }
            .slide { display: flex !important; break-after: page; height: 100vh; border: none; box-shadow: none; }
            body { background: white; -webkit-print-color-adjust: exact; }
        }

        /* Grid for Quiz */
        .grid-cards {
            display: grid; grid-template-columns: 1fr 1fr; gap: 20px; width: 100%;
        }
        .mini-card {
            padding: 20px; border-radius: 20px; text-align: left;
            transition: transform 0.2s; border: 2px solid transparent;
            background: #fff;
        }
        .mini-card:hover { transform: translateY(-5px); }
        
        .card-icon { font-size: 1.5rem; margin-bottom: 10px; display: block; }
        .card-jp { font-size: 1.2rem; font-weight: bold; display: block; margin-bottom: 5px; }
        .card-tw { font-size: 0.9rem; opacity: 0.8; }

    </style>
</head>
<body>

    <!-- Toolbar -->
    <div class="toolbar">
        <button class="tool-btn active" id="btn-brush" title="ç•«ç­† (Pen)"><i class="fas fa-pen"></i></button>
        <button class="tool-btn" id="btn-eraser" title="æ©¡çš®æ“¦ (Eraser)"><i class="fas fa-eraser"></i></button>
        <button class="tool-btn" id="btn-text" title="æ–‡å­— (Text)"><i class="fas fa-font"></i></button>
        <button class="tool-btn" id="btn-move" title="ç§»å‹• (Move)"><i class="fas fa-arrows-alt"></i></button>
        <button class="tool-btn" id="btn-print" title="åˆ—å° (Print)"><i class="fas fa-print"></i></button>
        
        <div class="color-palette" id="palette"></div>
    </div>

    <!-- Navigation -->
    <button class="nav-btn" id="prev-btn"><i class="fas fa-chevron-left"></i></button>
    <button class="nav-btn" id="next-btn"><i class="fas fa-chevron-right"></i></button>

    <!-- App Container -->
    <div id="app-container">
        
        <!-- Slide 1: Cover (Intro Theme) -->
        <div class="slide active" id="slide-1" data-theme="intro">
            <canvas class="drawing-layer"></canvas><div class="text-layer"></div>
            <div class="slide-content center-text" style="justify-content: center; text-align: center;">
                <div class="illustration" style="color: var(--theme-intro); margin-bottom: 20px;">
                    <i class="fas fa-battery-empty"></i>
                </div>
                <h1 style="font-family: var(--font-title); font-size: 3.5rem; color: #37474f; margin-bottom: 10px;">
                    ç–²ã‚ŒãŸ...<br>
                    <span style="font-size: 2rem; color: var(--theme-intro);">ç´¯åˆ°åƒæ³¥å·´ä¸€æ¨£ï¼Ÿ</span>
                </h1>
                <h2 style="font-family: var(--font-body); font-size: 1.5rem; color: #78909c;">
                    ç–²ã‚Œã®ãƒ¬ãƒ™ãƒ«ã‚’è¡¨ã™ã‚ªãƒãƒãƒˆãƒš<br>
                    <span style="font-size: 1.2rem;">å½¢å®¹å„ç¨®ç–²å‹ç¨‹åº¦çš„æ“¬æ…‹èª</span>
                </h2>
                <div style="margin-top: 40px; font-size: 1.2rem; background: var(--theme-intro); padding: 12px 40px; border-radius: 50px; color: white; font-weight: bold; box-shadow: 0 10px 20px rgba(84, 110, 122, 0.3);">
                    æ—¥èªæœƒè©±èª²ç¨‹ (æ—¥æœ¬èªä¼šè©±ãƒ¬ãƒƒã‚¹ãƒ³)
                </div>
            </div>
        </div>

        <!-- Slide 2: Scene (Theme: Intro) -->
        <div class="slide" id="slide-2" data-theme="intro">
            <canvas class="drawing-layer"></canvas><div class="text-layer"></div>
            <div class="slide-content">
                <div class="slide-header">
                    <h3 class="slide-title">å ´é¢ï¼šä»•äº‹çµ‚ã‚ã‚Š <small style="font-size:0.6em; color:#78909c;">(å ´é¢ï¼šä¸‹ç­å¾Œ)</small></h3>
                    <span class="slide-number">02 / 10</span>
                </div>
                <div class="slide-body">
                    <div class="col-left">
                        <p style="font-size: 1.3rem; line-height: 1.8;">
                            æ®‹æ¥­ã‚„é‹å‹•ã®ã‚ã¨ã€ã€Œç–²ã‚ŒãŸã€ã ã‘ã§ã¯è¶³ã‚Šãªã„æ™‚ãŒã‚ã‚Šã¾ã™ã€‚<br>
                            <span style="color:#78909c; font-size: 1.1rem;">åŠ ç­æˆ–é‹å‹•å¾Œï¼Œåªèªªã€Œç´¯äº†ã€æœ‰æ™‚ä¸¦ä¸è¶³å¤ ã€‚</span><br><br>
                            ã©ã‚Œãã‚‰ã„ç–²ã‚Œã¦ã„ã‚‹ã‹ã€ã‚ªãƒãƒãƒˆãƒšã§è¡¨ç¾ã—ã¦ã¿ã¾ã—ã‚‡ã†ã€‚<br>
                            <span style="color:#78909c; font-size: 1.1rem;">è©¦è‘—ç”¨æ“¬æ…‹èªä¾†è¡¨ç¾åˆ°åº•æœ‰å¤šç´¯å§ã€‚</span>
                        </p>
                        
                        <h4 style="color: var(--theme-intro); margin-top: 20px; font-size: 1.3rem;">ä»Šæ—¥çš„å­¸ç¿’é‡é» (ä»Šæ—¥ã®ãƒã‚¤ãƒ³ãƒˆ)ï¼š</h4>
                        <ul style="font-size: 1.2rem; list-style: none; padding: 0; line-height: 2;">
                            <li style="background:#efebe9; padding:5px 15px; border-radius:15px; margin-bottom:10px; color:#5d4037;">
                                <i class="fas fa-running"></i> <strong>ãƒ˜ãƒˆãƒ˜ãƒˆ</strong> (Heto-heto) - ç²¾ç–²åŠ›ç›¡
                            </li>
                            <li style="background:#f1f8e9; padding:5px 15px; border-radius:15px; margin-bottom:10px; color:#33691e;">
                                <i class="fas fa-leaf"></i> <strong>ã‚¯ã‚¿ã‚¯ã‚¿</strong> (Kuta-kuta) - è»Ÿè¶´è¶´
                            </li>
                            <li style="background:#e8eaf6; padding:5px 15px; border-radius:15px; margin-bottom:10px; color:#283593;">
                                <i class="fas fa-bed"></i> <strong>ãƒã‚¿ãƒ³ã‚­ãƒ¥ãƒ¼</strong> (Batan-kyu) - å€’é ­å°±ç¡
                            </li>
                        </ul>
                    </div>
                    <div class="col-right">
                        <i class="fas fa-couch illustration" style="color: var(--theme-intro);"></i>
                    </div>
                </div>
            </div>
        </div>

        <!-- Slide 3: Heto-heto (Brown Theme) -->
        <div class="slide" id="slide-3" data-theme="brown">
            <canvas class="drawing-layer"></canvas><div class="text-layer"></div>
            <div class="slide-content">
                <div class="slide-header">
                    <h3 class="slide-title">ä½“åŠ›æ¶ˆè€— <small style="font-size:0.6em; color:#78909c;">(é«”åŠ›è€—ç›¡)</small></h3>
                    <span class="slide-number">03 / 10</span>
                </div>
                <div class="slide-body">
                    <div class="col-left">
                        <div class="big-word" style="color: var(--theme-brown);">ãƒ˜ãƒˆãƒ˜ãƒˆ</div>
                        <div class="situation-tag">å ´é¢ï¼šãƒãƒ©ã‚½ãƒ³ã€å¼•è¶Šã— (é¦¬æ‹‰æ¾ã€æ¬å®¶)</div>
                        
                        <div class="definition-box" style="border-left-color: var(--theme-brown);">
                            <div class="def-jp">ä½“åŠ›ã‚’ä½¿ã„æœãŸã—ã¦ã€å‹•ã‘ãªã„ãã‚‰ã„ç–²ã‚ŒãŸæ§˜å­ã€‚æ¯ãŒåˆ‡ã‚Œã‚‹ã‚¤ãƒ¡ãƒ¼ã‚¸ã€‚</div>
                            <div class="def-tw">ç”¨ç›¡é«”åŠ›ï¼Œç´¯åˆ°å‹•å½ˆä¸å¾—çš„æ¨£å­ã€‚æœ‰å–˜ä¸éæ°£çš„æ„Ÿè¦ºã€‚</div>
                        </div>
                        
                        <!-- Chat -->
                        <div class="chat-container">
                            <div class="chat-title">æœƒè©± (ä¼šè©±)</div>
                            <div class="chat-row left">
                                <div class="chat-avatar" style="color:var(--theme-brown);"><i class="fas fa-user"></i></div>
                                <div class="chat-bubble">
                                    å¼•è¶Šã—ã€çµ‚ã‚ã£ãŸï¼Ÿ<br>
                                    <span style="font-size:0.8em; color:#78909c;">æ¬å®¶çµæŸäº†å—ï¼Ÿ</span>
                                </div>
                            </div>
                            <div class="chat-row right">
                                <div class="chat-bubble" style="background:var(--theme-brown); color:white;">
                                    ã†ã‚“ã€è·ç‰©ãŒé‡ãã¦ã€ã‚‚ã†<strong>ãƒ˜ãƒˆãƒ˜ãƒˆ</strong>ã ã‚ˆã€‚<br>
                                    <span style="font-size:0.8em; opacity:0.9;">å—¯ï¼Œè¡Œæå¥½é‡ï¼Œæˆ‘å·²ç¶“ç²¾ç–²åŠ›ç›¡(Heto-heto)äº†ã€‚</span>
                                </div>
                                <div class="chat-avatar" style="color:var(--theme-brown);"><i class="fas fa-dizzy"></i></div>
                            </div>
                        </div>
                    </div>
                    <div class="col-right">
                        <i class="fas fa-running illustration" style="color: var(--theme-brown);"></i>
                    </div>
                </div>
            </div>
        </div>

        <!-- Slide 4: Kuta-kuta (Green Theme) -->
        <div class="slide" id="slide-4" data-theme="green">
            <canvas class="drawing-layer"></canvas><div class="text-layer"></div>
            <div class="slide-content">
                <div class="slide-header">
                    <h3 class="slide-title">å‹å´©ã‚Œãƒ»è„±åŠ› <small style="font-size:0.6em; color:#78909c;">(è®Šå½¢ãƒ»è„«åŠ›)</small></h3>
                    <span class="slide-number">04 / 10</span>
                </div>
                <div class="slide-body">
                    <div class="col-left">
                        <div class="big-word" style="color: var(--theme-green);">ã‚¯ã‚¿ã‚¯ã‚¿</div>
                        <div class="situation-tag">å ´é¢ï¼šé•·æ™‚é–“ã®ä»•äº‹ã€ç…®ç‰© (é•·æ™‚é–“å·¥ä½œã€ç‡‰ç…®)</div>
                        
                        <div class="definition-box" style="border-left-color: var(--theme-green);">
                            <div class="def-jp">ç–²ã‚Œæœã¦ã¦ã€ä½“ã®åŠ›ãŒæŠœã‘ã¦ã—ã¾ã£ãŸæ§˜å­ã€‚é‡èœãªã©ã‚’ç…®è¾¼ã‚“ã æ™‚ã«ã‚‚ä½¿ã„ã¾ã™ã€‚</div>
                            <div class="def-tw">ç´¯å£äº†ï¼Œèº«é«”å®Œå…¨æ²’åŠ›æ°£çš„æ¨£å­ã€‚ä¹Ÿå¯ä»¥ç”¨ä¾†å½¢å®¹ç‡‰ç…®åˆ°è»Ÿçˆ›çš„è”¬èœã€‚</div>
                        </div>
                        
                        <!-- Chat -->
                        <div class="chat-container">
                            <div class="chat-title">æœƒè©± (ä¼šè©±)</div>
                            <div class="chat-row left">
                                <div class="chat-avatar" style="color:var(--theme-green);"><i class="fas fa-user"></i></div>
                                <div class="chat-bubble">
                                    ä»Šæ—¥ã¯ãšã£ã¨ç«‹ã¡ã£ã±ãªã—ã ã£ãŸã­ã€‚<br>
                                    <span style="font-size:0.8em; color:#78909c;">ä»Šå¤©ä¸€ç›´ç«™è‘—å‘¢ã€‚</span>
                                </div>
                            </div>
                            <div class="chat-row right">
                                <div class="chat-bubble" style="background:var(--theme-green); color:white;">
                                    è¶³ãŒæ£’ã®ã‚ˆã†ã ã€‚ä½“ã‚‚<strong>ã‚¯ã‚¿ã‚¯ã‚¿</strong>ã€‚<br>
                                    <span style="font-size:0.8em; opacity:0.9;">è…³åƒæœ¨æ£’ä¸€æ¨£ã€‚èº«é«”ä¹Ÿè»Ÿè¶´è¶´(Kuta-kuta)çš„ã€‚</span>
                                </div>
                                <div class="chat-avatar" style="color:var(--theme-green);"><i class="fas fa-leaf"></i></div>
                            </div>
                        </div>
                    </div>
                    <div class="col-right">
                        <i class="fas fa-carrot illustration" style="color: var(--theme-green);"></i>
                    </div>
                </div>
            </div>
        </div>

        <!-- Slide 5: Guttari (Purple Theme) -->
        <div class="slide" id="slide-5" data-theme="purple">
            <canvas class="drawing-layer"></canvas><div class="text-layer"></div>
            <div class="slide-content">
                <div class="slide-header">
                    <h3 class="slide-title">ç—…æ°—ãƒ»æš‘ã• <small style="font-size:0.6em; color:#78909c;">(ç”Ÿç—…ãƒ»ç‚ç†±)</small></h3>
                    <span class="slide-number">05 / 10</span>
                </div>
                <div class="slide-body">
                    <div class="col-left">
                        <div class="big-word" style="color: var(--theme-purple);">ã‚°ãƒƒã‚¿ãƒª</div>
                        <div class="situation-tag">å ´é¢ï¼šå¤ãƒãƒ†ã€ç™ºç†± (ä¸­æš‘ã€ç™¼ç‡’)</div>
                        
                        <div class="definition-box" style="border-left-color: var(--theme-purple);">
                            <div class="def-jp">ç—…æ°—ã‚„æš‘ã•ãªã©ã§ã€æ€¥ã«åŠ›ãŒæŠœã‘ã¦å¼±ã£ã¦ã—ã¾ã†æ§˜å­ã€‚</div>
                            <div class="def-tw">å› ç‚ºç”Ÿç—…æˆ–ç‚ç†±ç­‰åŸå› ï¼Œçªç„¶æ²’åŠ›æ°£ã€è™›å¼±çš„æ¨£å­ã€‚</div>
                        </div>
                        
                        <!-- Chat -->
                        <div class="chat-container">
                            <div class="chat-title">æœƒè©± (ä¼šè©±)</div>
                            <div class="chat-row left">
                                <div class="chat-avatar" style="color:var(--theme-purple);"><i class="fas fa-user"></i></div>
                                <div class="chat-bubble">
                                    æ„›çŠ¬ã®ãƒãƒã€å…ƒæ°—ãªã„ã­ã€‚<br>
                                    <span style="font-size:0.8em; color:#78909c;">æ³¢å¥‡(ç‹—ç‹—)çœ‹èµ·ä¾†æ²’ç²¾ç¥å‘¢ã€‚</span>
                                </div>
                            </div>
                            <div class="chat-row right">
                                <div class="chat-bubble" style="background:var(--theme-purple); color:white;">
                                    æš‘ã•ã§<strong>ã‚°ãƒƒã‚¿ãƒª</strong>ã—ã¦ã‚‹ã¿ãŸã„ã€‚<br>
                                    <span style="font-size:0.8em; opacity:0.9;">å¥½åƒæ˜¯ç†±åˆ°ç™±è»Ÿ(Guttari)äº†ã€‚</span>
                                </div>
                                <div class="chat-avatar" style="color:var(--theme-purple);"><i class="fas fa-dog"></i></div>
                            </div>
                        </div>
                    </div>
                    <div class="col-right">
                        <i class="fas fa-thermometer-full illustration" style="color: var(--theme-purple);"></i>
                    </div>
                </div>
            </div>
        </div>

        <!-- Slide 6: Batan-kyu (Blue Theme) -->
        <div class="slide" id="slide-6" data-theme="blue">
            <canvas class="drawing-layer"></canvas><div class="text-layer"></div>
            <div class="slide-content">
                <div class="slide-header">
                    <h3 class="slide-title">å³ãƒ»çˆ†ç¡ <small style="font-size:0.6em; color:#78909c;">(ç«‹å³ãƒ»çˆ†ç¡)</small></h3>
                    <span class="slide-number">06 / 10</span>
                </div>
                <div class="slide-body">
                    <div class="col-left">
                        <div class="big-word" style="color: var(--theme-blue);">ãƒã‚¿ãƒ³ã‚­ãƒ¥ãƒ¼</div>
                        <div class="situation-tag">å ´é¢ï¼šå¸°å®…å¾Œã€å¾¹å¤œæ˜ã‘ (å›å®¶å¾Œã€ç†¬å¤œå¾Œ)</div>
                        
                        <div class="definition-box" style="border-left-color: var(--theme-blue);">
                            <div class="def-jp">å¸°å®…ã—ã¦ã™ãã«å€’ã‚Œè¾¼ã‚€ã‚ˆã†ã«å¯ã¦ã—ã¾ã†ã“ã¨ã€‚ã€Œãƒã‚¿ãƒ³ï¼ˆå€’ã‚Œã‚‹éŸ³ï¼‰ã€ï¼‹ã€Œã‚­ãƒ¥ãƒ¼ï¼ˆé™ã‹ã«ãªã‚‹ï¼‰ã€ã€‚</div>
                            <div class="def-tw">å›å®¶å¾Œåƒå€’ä¸‹ä¸€æ¨£ç«‹åˆ»ç¡è‘—ã€‚ã€ŒBatanï¼ˆå€’ä¸‹è²ï¼‰ã€ï¼‹ã€ŒKyuï¼ˆè®Šå®‰éœï¼‰ã€ã€‚</div>
                        </div>
                        
                        <!-- Chat -->
                        <div class="chat-container">
                            <div class="chat-title">æœƒè©± (ä¼šè©±)</div>
                            <div class="chat-row left">
                                <div class="chat-avatar" style="color:var(--theme-blue);"><i class="fas fa-user"></i></div>
                                <div class="chat-bubble">
                                    æ˜¨æ—¥ã¯ã™ãé€£çµ¡ãã‚ŒãŸã­ã€‚<br>
                                    <span style="font-size:0.8em; color:#78909c;">æ˜¨å¤©ä½ æ²’æœ‰é¦¬ä¸Šè¯çµ¡æˆ‘å‘¢ã€‚</span>
                                </div>
                            </div>
                            <div class="chat-row right">
                                <div class="chat-bubble" style="background:var(--theme-blue); color:white;">
                                    ã”ã‚ã‚“ã€ç–²ã‚Œã¦<strong>ãƒã‚¿ãƒ³ã‚­ãƒ¥ãƒ¼</strong>ã—ã¡ã‚ƒã£ãŸã€‚<br>
                                    <span style="font-size:0.8em; opacity:0.9;">æŠ±æ­‰ï¼Œæˆ‘å¤ªç´¯ä¸€å›å®¶å°±å€’é ­ç¡è‘—(Batan-kyu)äº†ã€‚</span>
                                </div>
                                <div class="chat-avatar" style="color:var(--theme-blue);"><i class="fas fa-bed"></i></div>
                            </div>
                        </div>
                    </div>
                    <div class="col-right">
                        <i class="fas fa-moon illustration" style="color: var(--theme-blue);"></i>
                    </div>
                </div>
            </div>
        </div>

        <!-- Slide 7: Boro-boro (Grey Theme) -->
        <div class="slide" id="slide-7" data-theme="grey">
            <canvas class="drawing-layer"></canvas><div class="text-layer"></div>
            <div class="slide-content">
                <div class="slide-header">
                    <h3 class="slide-title">å¿ƒèº«æ¶ˆè€— <small style="font-size:0.6em; color:#78909c;">(èº«å¿ƒä¿±ç–²)</small></h3>
                    <span class="slide-number">07 / 10</span>
                </div>
                <div class="slide-body">
                    <div class="col-left">
                        <div class="big-word" style="color: var(--theme-grey);">ãƒœãƒ­ãƒœãƒ­</div>
                        <div class="situation-tag">å ´é¢ï¼šé€£å‹¤ã€ç²¾ç¥çš„ãƒ€ãƒ¡ãƒ¼ã‚¸ (é€£æ—¥å·¥ä½œã€ç²¾ç¥æ‰“æ“Š)</div>
                        
                        <div class="definition-box" style="border-left-color: var(--theme-grey);">
                            <div class="def-jp">æœãªã©ãŒç ´ã‚Œã¦ã„ã‚‹æ§˜å­ã‹ã‚‰ã€ä½“ã‚„å¿ƒãŒã²ã©ãç–²ã‚Œã¦ã„ã‚‹çŠ¶æ…‹ã‚’è¡¨ã—ã¾ã™ã€‚</div>
                            <div class="def-tw">åŸæŒ‡è¡£æœç ´çˆ›çš„æ¨£å­ï¼Œå¼•ç”³ç‚ºèº«å¿ƒæ¥µåº¦ç–²æ†Šã€æ®˜ç ´ä¸å ªçš„ç‹€æ…‹ã€‚</div>
                        </div>
                        
                        <!-- Chat -->
                        <div class="chat-container">
                            <div class="chat-title">æœƒè©± (ä¼šè©±)</div>
                            <div class="chat-row left">
                                <div class="chat-avatar" style="color:var(--theme-grey);"><i class="fas fa-user"></i></div>
                                <div class="chat-bubble">
                                    ãƒ—ãƒ­ã‚¸ã‚§ã‚¯ãƒˆã€ã‚„ã£ã¨çµ‚ã‚ã£ãŸã­ã€‚<br>
                                    <span style="font-size:0.8em; color:#78909c;">å°ˆæ¡ˆçµ‚æ–¼çµæŸäº†å‘¢ã€‚</span>
                                </div>
                            </div>
                            <div class="chat-row right">
                                <div class="chat-bubble" style="background:var(--theme-grey); color:white;">
                                    ã†ã‚“ã€ã§ã‚‚å¿ƒã‚‚ä½“ã‚‚<strong>ãƒœãƒ­ãƒœãƒ­</strong>ã ã‚ˆã€‚<br>
                                    <span style="font-size:0.8em; opacity:0.9;">å—¯ï¼Œä½†æˆ‘å·²ç¶“èº«å¿ƒä¿±ç–²(Boro-boro)äº†ã€‚</span>
                                </div>
                                <div class="chat-avatar" style="color:var(--theme-grey);"><i class="fas fa-battery-empty"></i></div>
                            </div>
                        </div>
                    </div>
                    <div class="col-right">
                        <i class="fas fa-heart-broken illustration" style="color: var(--theme-grey);"></i>
                    </div>
                </div>
            </div>
        </div>

        <!-- Slide 8: Review Quiz (Green Theme) -->
        <div class="slide" id="slide-8" data-theme="green">
            <canvas class="drawing-layer"></canvas><div class="text-layer"></div>
            <div class="slide-content">
                <div class="slide-header">
                    <h3 class="slide-title">ç·´ç¿’å•é¡Œ <small style="font-size:0.6em; color:#78909c;">(ç·´ç¿’é¡Œ)</small></h3>
                    <span class="slide-number">08 / 10</span>
                </div>
                <div class="slide-body" style="flex-direction: column;">
                    <p style="text-align: center; color: #555; font-size: 1.2rem;">
                        æ­£ã—ã„è¨€è‘‰ã‚’é¸ã‚“ã§æ›¸ãã¾ã—ã‚‡ã†ï¼<br>
                        <span style="font-size:1rem; color:#78909c;">è«‹ä½¿ç”¨ç•«ç­†å·¥å…·å¡«å…¥æ­£ç¢ºçš„è©å½™ï¼</span>
                    </p>
                    
                    <div class="grid-cards">
                        <!-- Card 1 -->
                        <div class="mini-card" style="background:#efebe9; border-color:#d7ccc8;">
                            <span class="card-icon" style="color:#5d4037;"><i class="fas fa-running"></i></span>
                            <span class="card-jp">é‹å‹•ã—ã¦æ¯åˆ‡ã‚Œ</span>
                            <span class="card-tw">é‹å‹•å¾Œæ°£å–˜åå</span>
                            <div style="margin-top:10px; font-weight:bold; font-size:1.5rem; color:#4e342e;">ã€Œ_______ã€</div>
                        </div>
                        <!-- Card 2 -->
                        <div class="mini-card" style="background:#ede7f6; border-color:#d1c4e9;">
                            <span class="card-icon" style="color:#512da8;"><i class="fas fa-thermometer-full"></i></span>
                            <span class="card-jp">ç†±ã§å‹•ã‘ãªã„</span>
                            <span class="card-tw">ç™¼ç‡’å‹•å½ˆä¸å¾—</span>
                            <div style="margin-top:10px; font-weight:bold; font-size:1.5rem; color:#4527a0;">ã€Œ_______ã€</div>
                        </div>
                        <!-- Card 3 -->
                        <div class="mini-card" style="background:#e8eaf6; border-color:#c5cae9;">
                            <span class="card-icon" style="color:#283593;"><i class="fas fa-bed"></i></span>
                            <span class="card-jp">å³ãƒ»çˆ†ç¡</span>
                            <span class="card-tw">ç«‹åˆ»ç¡è‘—</span>
                            <div style="margin-top:10px; font-weight:bold; font-size:1.5rem; color:#1a237e;">ã€Œ_______ã€</div>
                        </div>
                        <!-- Card 4 -->
                        <div class="mini-card" style="background:#f1f8e9; border-color:#dcedc8;">
                            <span class="card-icon" style="color:#33691e;"><i class="fas fa-carrot"></i></span>
                            <span class="card-jp">ä½“ãŒè»Ÿã‚‰ã‹ãç–²ã‚Œã‚‹</span>
                            <span class="card-tw">èº«é«”è»Ÿè¶´è¶´</span>
                            <div style="margin-top:10px; font-weight:bold; font-size:1.5rem; color:#1b5e20;">ã€Œ_______ã€</div>
                        </div>
                    </div>
                    
                    <div style="margin-top: 20px; text-align: center; color: #78909c;">
                        é¸æ“‡ï¼šãƒ˜ãƒˆãƒ˜ãƒˆã€ãƒã‚¿ãƒ³ã‚­ãƒ¥ãƒ¼ã€ã‚¯ã‚¿ã‚¯ã‚¿ã€ã‚°ãƒƒã‚¿ãƒª
                    </div>
                </div>
            </div>
        </div>

        <!-- Slide 9: Conclusion (Intro Theme) -->
        <div class="slide" id="slide-9" data-theme="intro">
            <canvas class="drawing-layer"></canvas><div class="text-layer"></div>
            <div class="slide-content center-text" style="justify-content: center; text-align: center;">
                <div style="font-size: 6rem; color: var(--theme-intro); margin-bottom: 20px;">
                    <i class="fas fa-coffee"></i>
                </div>
                <h2 style="font-family: var(--font-title); font-size: 3rem; color: #37474f; margin-bottom: 5px;">
                    ãŠç–²ã‚Œæ§˜ã§ã—ãŸï¼
                </h2>
                <h3 style="font-size: 1.5rem; color: #78909c; font-weight: normal; margin-bottom: 30px;">
                    (è¾›è‹¦äº†ï¼)
                </h3>
                
                <div style="width: 85%; text-align: left; background: #fff; padding: 30px; border-radius: 20px; border: 2px dashed #b0bec5; box-shadow: 0 5px 15px rgba(0,0,0,0.05);">
                    <h3 style="color: var(--theme-intro); border-bottom: 1px solid #eee; padding-bottom: 10px; margin-top:0;">ç¸½çµ (ã¾ã¨ã‚)ï¼š</h3>
                    <ul style="font-size: 1.2rem; line-height: 2.2; list-style: none; padding-left: 0;">
                        <li><span style="color:#8d6e63;">ğŸƒ <strong>ãƒ˜ãƒˆãƒ˜ãƒˆ</strong></span>ï¼šé«”åŠ›è€—ç›¡ (Exhausted)</li>
                        <li><span style="color:#7cb342;">ğŸ¥¬ <strong>ã‚¯ã‚¿ã‚¯ã‚¿</strong></span>ï¼šè»Ÿè¶´è¶´ (Worn out)</li>
                        <li><span style="color:#7e57c2;">ğŸ¤’ <strong>ã‚°ãƒƒã‚¿ãƒª</strong></span>ï¼šç—…å¼±ç™±è»Ÿ (Limp/Sick)</li>
                        <li><span style="color:#3949ab;">ğŸ›Œ <strong>ãƒã‚¿ãƒ³ã‚­ãƒ¥ãƒ¼</strong></span>ï¼šå€’é ­å°±ç¡ (Crash sleep)</li>
                        <li><span style="color:#78909c;">ğŸ’” <strong>ãƒœãƒ­ãƒœãƒ­</strong></span>ï¼šèº«å¿ƒä¿±ç–² (Tattered)</li>
                    </ul>
                </div>
                <p style="margin-top: 30px; font-weight: bold; font-size: 1.3rem; color: var(--theme-intro);">
                    ä»Šæ—¥ã¯ã‚†ã£ãã‚Šä¼‘ã‚“ã§ãã ã•ã„ã­ï¼<br>
                    <span style="font-size: 1rem; color: #78909c; font-weight: normal;">ä»Šå¤©è«‹å¥½å¥½ä¼‘æ¯å–”ï¼</span>
                </p>
            </div>
        </div>

    </div>

    <script>
        // --- State Management ---
        const state = {
            currentSlide: 1,
            totalSlides: 9,
            tool: 'brush', 
            color: '#333333',
            isDrawing: false,
            lastX: 0,
            lastY: 0,
            brushSize: 4
        };

        // --- Elements ---
        const slides = document.querySelectorAll('.slide');
        const prevBtn = document.getElementById('prev-btn');
        const nextBtn = document.getElementById('next-btn');
        const palette = document.getElementById('palette');

        // --- Colors Palette (Fatigue) ---
        const colors = [
            '#333333', '#8d6e63', // Black, Brown
            '#7cb342', '#7e57c2', // Green, Purple
            '#3949ab', '#78909c', // Blue, Grey
            '#ff7043', '#26a69a'  // Orange, Teal (Accent)
        ];

        function init() {
            setupNavigation();
            setupPalette();
            setupTools();
            setupCanvasForSlide(1);
            setupTextLayer(1);
            updateSlideVisibility();
            
            window.addEventListener('resize', () => resizeCanvas(state.currentSlide));
        }

        // --- Navigation ---
        function setupNavigation() {
            prevBtn.addEventListener('click', () => changeSlide(-1));
            nextBtn.addEventListener('click', () => changeSlide(1));
            
            document.getElementById('btn-print').addEventListener('click', () => {
                slides.forEach((slide, index) => resizeCanvas(index + 1));
                window.print();
            });
        }

        function changeSlide(direction) {
            const next = state.currentSlide + direction;
            if (next >= 1 && next <= state.totalSlides) {
                state.currentSlide = next;
                updateSlideVisibility();
                setupCanvasForSlide(next);
                setupTextLayer(next);
            }
        }

        function updateSlideVisibility() {
            slides.forEach((slide, index) => {
                slide.classList.toggle('active', index + 1 === state.currentSlide);
            });
            prevBtn.style.opacity = state.currentSlide === 1 ? '0.5' : '1';
            prevBtn.style.pointerEvents = state.currentSlide === 1 ? 'none' : 'auto';
            nextBtn.style.opacity = state.currentSlide === state.totalSlides ? '0.5' : '1';
            nextBtn.style.pointerEvents = state.currentSlide === state.totalSlides ? 'none' : 'auto';
        }

        // --- Palette & Tools ---
        function setupPalette() {
            colors.forEach(color => {
                const swatch = document.createElement('div');
                swatch.className = 'color-swatch';
                swatch.style.backgroundColor = color;
                swatch.addEventListener('click', () => setColor(color, swatch));
                palette.appendChild(swatch);
            });
            palette.children[0].classList.add('active');
            state.color = colors[0];
        }

        function setColor(color, element) {
            state.color = color;
            document.querySelectorAll('.color-swatch').forEach(el => el.classList.remove('active'));
            element.classList.add('active');
            if (state.tool === 'eraser') setTool('brush');
        }

        function setupTools() {
            const tools = {
                'btn-brush': 'brush',
                'btn-eraser': 'eraser',
                'btn-text': 'text',
                'btn-move': 'move'
            };
            for (const [id, toolName] of Object.entries(tools)) {
                document.getElementById(id).addEventListener('click', () => setTool(toolName));
            }
        }

        function setTool(toolName) {
            state.tool = toolName;
            document.querySelectorAll('.tool-btn').forEach(btn => btn.classList.remove('active'));
            document.getElementById(`btn-${toolName}`).classList.add('active');
            updateLayerInteractions();
        }

        function updateLayerInteractions() {
            const activeSlide = document.getElementById(`slide-${state.currentSlide}`);
            const canvas = activeSlide.querySelector('.drawing-layer');
            const textLayer = activeSlide.querySelector('.text-layer');

            if (state.tool === 'brush' || state.tool === 'eraser') {
                canvas.style.pointerEvents = 'auto';
                textLayer.style.pointerEvents = 'none';
                canvas.style.cursor = 'crosshair';
            } else if (state.tool === 'text') {
                canvas.style.pointerEvents = 'none';
                textLayer.style.pointerEvents = 'auto';
                textLayer.style.cursor = 'text';
            } else if (state.tool === 'move') {
                canvas.style.pointerEvents = 'none';
                textLayer.style.pointerEvents = 'auto';
                textLayer.style.cursor = 'default';
            }
        }

        // --- Canvas Drawing ---
        function setupCanvasForSlide(slideIndex) {
            const slide = document.getElementById(`slide-${slideIndex}`);
            const canvas = slide.querySelector('.drawing-layer');
            if (canvas.width !== slide.clientWidth) resizeCanvas(slideIndex);
            
            const ctx = canvas.getContext('2d');
            ctx.lineCap = 'round';
            ctx.lineJoin = 'round';

            if (!canvas.dataset.listenersAdded) {
                canvas.addEventListener('mousedown', startDrawing);
                canvas.addEventListener('mousemove', draw);
                canvas.addEventListener('mouseup', stopDrawing);
                canvas.addEventListener('mouseout', stopDrawing);
                canvas.dataset.listenersAdded = 'true';
            }
        }

        function resizeCanvas(slideIndex) {
            const slide = document.getElementById(`slide-${slideIndex}`);
            const canvas = slide.querySelector('.drawing-layer');
            const ctx = canvas.getContext('2d');

            let tempCanvas;
            if (canvas.width > 0 && canvas.height > 0) {
                 tempCanvas = document.createElement('canvas');
                 tempCanvas.width = canvas.width;
                 tempCanvas.height = canvas.height;
                 tempCanvas.getContext('2d').drawImage(canvas, 0, 0);
            }

            canvas.width = slide.clientWidth;
            canvas.height = slide.clientHeight;

            if (tempCanvas) {
                ctx.drawImage(tempCanvas, 0, 0, canvas.width, canvas.height);
            }
        }

        function startDrawing(e) {
            if (state.tool !== 'brush' && state.tool !== 'eraser') return;
            state.isDrawing = true;
            const rect = e.target.getBoundingClientRect();
            state.lastX = e.clientX - rect.left;
            state.lastY = e.clientY - rect.top;
        }

        function draw(e) {
            if (!state.isDrawing) return;
            const ctx = e.target.getContext('2d');
            const rect = e.target.getBoundingClientRect();
            const x = e.clientX - rect.left;
            const y = e.clientY - rect.top;

            ctx.lineWidth = state.tool === 'eraser' ? 20 : state.brushSize;
            ctx.strokeStyle = state.tool === 'eraser' ? 'rgba(0,0,0,1)' : state.color;
            ctx.globalCompositeOperation = state.tool === 'eraser' ? 'destination-out' : 'source-over';

            ctx.beginPath();
            ctx.moveTo(state.lastX, state.lastY);
            ctx.lineTo(x, y);
            ctx.stroke();

            state.lastX = x;
            state.lastY = y;
        }

        function stopDrawing() { state.isDrawing = false; }

        // --- Text Tool ---
        function setupTextLayer(slideIndex) {
            const slide = document.getElementById(`slide-${slideIndex}`);
            const textLayer = slide.querySelector('.text-layer');
            if (!textLayer.dataset.listenersAdded) {
                textLayer.addEventListener('click', (e) => {
                    if (state.tool === 'text' && e.target === textLayer) {
                        createTextField(e.offsetX, e.offsetY, textLayer);
                    }
                });
                textLayer.dataset.listenersAdded = 'true';
            }
        }

        function createTextField(x, y, container) {
            const div = document.createElement('div');
            div.className = 'user-text';
            div.contentEditable = true;
            div.style.left = x + 'px';
            div.style.top = y + 'px';
            div.style.color = state.color;
            div.innerHTML = ''; 
            
            div.addEventListener('mousedown', (e) => {
                if (state.tool === 'move') {
                    e.preventDefault(); 
                    initDrag(e, div);
                } else {
                    e.stopPropagation();
                }
            });

            container.appendChild(div);
            setTimeout(() => div.focus(), 0);
            div.addEventListener('blur', () => {
                if(div.innerText.trim() === '') div.remove();
            });
        }

        function initDrag(e, el) {
            el.classList.add('draggable');
            const startX = e.clientX;
            const startY = e.clientY;
            const rect = el.getBoundingClientRect();
            const parentRect = el.parentElement.getBoundingClientRect();
            const offsetX = startX - rect.left;
            const offsetY = startY - rect.top;

            function onMouseMove(moveEvent) {
                const newX = moveEvent.clientX - parentRect.left - offsetX;
                const newY = moveEvent.clientY - parentRect.top - offsetY;
                el.style.left = newX + 'px';
                el.style.top = newY + 'px';
            }

            function onMouseUp() {
                el.classList.remove('draggable');
                document.removeEventListener('mousemove', onMouseMove);
                document.removeEventListener('mouseup', onMouseUp);
            }
            document.addEventListener('mousemove', onMouseMove);
            document.addEventListener('mouseup', onMouseUp);
        }

        init();
    </script>
</body>
</html>


